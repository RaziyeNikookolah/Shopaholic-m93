{% extends 'base.html' %}
{% block title %}
  Shoes Online Shop
{% endblock %}
{% block content %}
{% load static %} 
    <div class="bg-light py-3">
      <div class="container">
        <div class="row">
          <div class="col-md-12 mb-0"><a href="{% url 'home:index' %}">Home</a> <span class="mx-2 mb-0">/</span> <a href="{% url 'home:cart' %}">Cart</a> <span class="mx-2 mb-0">/</span> <strong class="text-black">Checkout</strong></div>
        </div>
      </div>
    </div>

    <div class="site-section">
      <div class="container">

        <div class="row">
          <div class="col-md-6 mb-5 mb-md-0">
            <h2 class="h3 mb-3 text-black">Billing Details</h2>
            <div class="p-3 p-lg-5 border">

              <div class="form-group row" id="div_fname_and_lname">
                
              </div>

              


                       
                <div class="form-group row">
                  <div class="col-md-12">
                    <h2 class="h3 mb-3 text-black">Addresses</h2>
                    
                    <div class="form-group">
                      <label class="text-black">Select an Address:</label>
                      <div id="address-list">
                        <!-- Radio buttons will be dynamically added here -->
                      </div>
                    </div>
                    
                    <!-- Address fields initially hidden -->
                    <div id="selected-address-fields" style="display: none;">
                      <div class="form-group row">
                        <div class="col-md-12">
                          <label for="c_address" class="text-black">Address <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" id="c_address" readonly name="c_address" placeholder="Street address">
                          <input type="hidden" class="form-control" id="c_address_id" name="c_address_id" placeholder="Street address">
                        </div>
                      </div>
                  
                      <div class="form-group">
                        <input id="c_city" type="text" class="form-control" readonly placeholder="City">
                      </div>
                  
                      <div class="form-group row">
                        <div class="col-md-6">
                          <label for="c_state_country" class="text-black">State / Country <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" id="c_state_country" readonly name="c_state_country">
                        </div>
                        <div class="col-md-6">
                          <label for="c_postal_zip" class="text-black">Postal / Zip <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" id="c_postal_zip" readonly name="c_postal_zip">
                        </div>
                      </div>           
  
                    </div>
                    
                  </div>
                </div>
                

                                
              <div class="form-group">
                <label for="c_order_notes" class="text-black">Order Notes</label>
                <textarea name="c_order_notes" id="c_order_notes" cols="30" rows="5" class="form-control" placeholder="Write your notes here..."></textarea>
              </div>             

              <div class="form-group">
                <label for="c_ship_different_address" class="text-black" data-toggle="collapse" href="#ship_different_address" role="button" aria-expanded="false" aria-controls="ship_different_address">
                  <input type="checkbox" value="1" id="c_ship_different_address"> Ship To Another Address?</label> 
                <div class="collapse" id="ship_different_address">
                  <div class="py-2">

                    <div class="form-group">
                      <label for="c_diff_country" class="text-black">Province <span class="text-danger">*</span></label>
                      <select id="c_diff_country" class="form-control">
                        <option value="">Select a province</option>
                        {% for province_code, province_name in PROVINCES %}
                          <option value="{{ province_code }}">{{ province_name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="form-group row">
                      <div class="col-md-6">
                        <label for="c_diff_city" class="text-black">City <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="c_diff_city" name="c_diff_city">
                      </div>
                      <div class="col-md-6">
                        <label for="c_diff_postal_zip" class="text-black">Postal / Zip <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="c_diff_postal_zip" name="c_diff_postal_zip">
                      </div>
                    </div>
                    <div class="form-group row">
                      <div class="col-md-12">
                        <label for="c_diff_address" class="text-black">Address <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="c_diff_address" name="c_diff_address" placeholder="Street address">
                      </div>
                    </div>
                    <div class="form-group row">
                      <div class="col-md-6">
                        <label for="c_diff_fname" class="text-black">First Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="c_diff_fname" name="c_diff_fname">
                      </div>
                      <div class="col-md-6">
                        <label for="c_diff_lname" class="text-black">Last Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="c_diff_lname" name="c_diff_lname">
                      </div>
                    </div>

                    <div class="form-group row mb-5">
                     
                      <div class="col-md-12">
                        <label for="c_diff_phone" class="text-black">Phone <span class="text-danger">*</span></label>
                        <input type="text" class="form-control w-100" id="c_diff_phone" name="c_diff_phone" placeholder="Phone Number">
                      </div>
                    </div>

                  </div>

                </div>
              </div>




            </div>
          </div>
          <div class="col-md-6">

            <div class="row mb-5">
              <div class="col-md-12">
                <h2 class="h3 mb-3 text-black">Your Order</h2>
                <div class="p-3 p-lg-5 border">
                  <table class="table site-block-order-table mb-5">
                    <thead>
                      <th>Product</th>
                      <th>Total</th>
                    </thead>
                    <tbody id="order_product">

                    </tbody>
                  </table>


                  <div class="form-group">
                    <a class="btn btn-primary btn-lg py-3 btn-block" id="save_order" href="#">Place Order</a>
                  </div>

                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
    {% load static %} 
    <script src="{% static 'js/jquery-3.3.1.min.js'%}"></script>
    <script src="{% static 'js/jquery-ui.js'%}"></script>
    <script src="{% static 'js/popper.min.js'%}"></script>
    <script src="{% static 'js/bootstrap.min.js'%}"></script>
    <script src="{% static 'js/owl.carousel.min.js'%}"></script>
    <script src="{% static 'js/jquery.magnific-popup.min.js'%}"></script>
    <script src="{% static 'js/aos.js'%}"></script>  
    <script src="{% static 'js/main.js'%}"></script>


<script>
  let userId=0;
  let accessToken = window.localStorage.getItem('accessToken');

  $(document).ready(function() {  
      const url="http://127.0.0.1:8000/api/v1/accounts/get_user_id_from_token/";
      $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json',
        beforeSend: function (xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        },
        success: function (data) {
          userId=data.userId;
          loadAccountDetails(userId);
        },
        error: function (jqXhr, textStatus, errorMessage) {
            console.log('Error in loading data', errorMessage);
        },
    });
    $("#update-address-btn").click(function() {
      update_address(); // Call the function without arguments
  });
  $("#delete-address-btn").click(function() {
    delete_address(); // Call the function without arguments
});

$("#add-address-btn").click(function() {
  add_address(); // Call the function without arguments
});

    $.ajax({
    url : "http://localhost:8000/order/cart_list/",
    type: 'GET',
    dataType: "json",
    beforeSend: function(xhr) {
      xhr.setRequestHeader("Authorization", "Bearer " + accessToken);
    },
    success: function (data, status, xhr) {
      cartData = data;      
     output='<tbody id="order_product">';
      // Iterate over the cart items and create a table row for each item
      
      for (var itemId in cartData.cart_items) {
        var item = cartData.cart_items[itemId];
        output+="<tr><td>"+item['title'] +"<strong class='mx-2'>x</strong> 1</td><td>"+item['sub_total']+"</td></tr>";  }
        output+="<strong class='mx-2'>"+itemId['grand_total']+"</strong> 1</td><td>";
        output+='</tbody>';
  $('#order_product').html(output);
    },
  error: function (jqXhr, textStatus, errorMessage) { // error callback 
    //console.log('Error in loading data', errorMessage);
  }
  });

  $('#save_order').click(function(event) {
    event.preventDefault();
  



var shipDifferentAddressCheckbox = document.getElementById('c_ship_different_address');
let data={};
if (shipDifferentAddressCheckbox.checked) {

  var fname = $('#c_diff_fname').val();
  var lname = $('#c_diff_lname').val();
  var address = $('#c_diff_address').val();
  var province = $('#c_diff_country').val();
  var phone_number = $("#c_diff_phone").val();
  var city = $("#c_diff_city").val();
  var postal_zip = $("#c_diff_postal_zip").val();
  var order_note = $("#c_order_notes").val();

     data = {
      "fname": fname,
      "lname": lname,
      "phone_number": phone_number,
      "postal_zip": postal_zip,
      "province":province,
      "address": address,
      "order_note": order_note,
      "city":city
    };



} else {


  var fname = $('#c_fname').val();
  var lname = $('#c_lname').val();
  var address = $('#c_address').val();
  var province = $('#c_state_country').val();
  var phone_number = $("#c_phone").val();
  var city = $("#c_city").val();
  var postal_zip = $("#c_postal_zip").val();
  var order_note = $("#c_order_notes").val();

    data = {
      "fname": fname,
      "lname": lname,
      "phone_number": phone_number,
      "postal_zip": postal_zip,
      "province":province,
      "address": address,
      "order_note": order_note,
      "city":city
    };
  }
    console.log("***********",data);
    $.ajax({
      
      url: 'http://localhost:8000/order/create_order/',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(data),
      beforeSend: function(xhr) {
        xhr.setRequestHeader("Authorization", "Bearer " + accessToken);
      },
      success: function(response) {

         $.ajax({
           url: 'http://localhost:8000/order/request/'+response['order_id'],
           type: 'GET',
           contentType: 'application/json',
           beforeSend: function(xhr) {
             xhr.setRequestHeader("Authorization", "Bearer " + accessToken);
           },
           success: function(response) {
             console.log(response);

           },
           error: function(error) {
             console.error('Error:', error);
           }
         }); 



      },
      error: function(error) {
        console.error('Error:', error);
      }
    });
  }); 
});



function loadAccountDetails(userId) {
  const url="http://127.0.0.1:8000/api/v1/account/accounts/"+userId+"/";
  $.ajax({
    url: url,
    type: 'GET',
    dataType: 'json',
    beforeSend: function (xhr) {
        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
    },
    success: function (data) {
    if (data.profile.first_name==null){
      console.log("%%%%%%%%")
      var to_url='http://127.0.0.1:8000/accounts/profile/';
      window.location=to_url;
    }
      const output='<div id="account_details">'+
        '<div class="form-group row">'+
          '<div class="col-md-6">'+
            '<label for="c_fname" class="text-black">First Name <span class="text-danger">*</span></label>'+
            '<input type="text" class="form-control" id="c_fname" readonly name="c_fname" value="'+data.profile.first_name+'" >'+
          '</div>'+
          '<div class="col-md-6">'+
            '<label for="c_lname" class="text-black">Last Name <span class="text-danger">*</span></label>'+
           ' <input type="text" class="form-control" id="c_lname" readonly name="c_lname" value="'+data.profile.last_name+'">'+
         ' </div>'+
        '</div>'+        
        '<div class="form-group row mb-5">'+   
          '<div class="col-md-12">'+
            '<label for="c_phone" class="text-black">Phone <span class="text-danger">*</span></label>'+
            '<input type="text" class="form-control w-100" id="c_phone" name="c_phone" placeholder="Phone Number"  readonly value="'+data.phone_number+'">'+
          '</div>'+
        '</div>'+      
        '</div>';
    $("#div_fname_and_lname").html(output);

getAddresses(data);


    },
    error: function (jqXhr, textStatus, errorMessage) {
        console.log('Error in loading data', errorMessage);
    },
});
}


function getAddresses(data){


const provinceValueMap={


'thr':'Tehran',
'az-sh':'Azarbayejan Sharghi',
'az-gh':'Azarbayejan Gharbi',
'ard':'Ardebil',
'esf':'Esfehan',
'alb':'Alborz',
'ilm':'Ilam',
'bsh':'Booshehr',
'chm':'Charmahal o Bakhtiari',
'kh-j':'Khorasan Jonobi',
'kh-r':'Khorasan Razavi',
'kh-sh':'Khorasan Shomali',
'khz':'Khoozestan',
'znj':'Zanjan',
'smn':'Semnan',
'sbch':'Sistan Baloochestan',
'frs':'Fars',
'ghz':'Ghazvin',
'qom':'Qom',
'krd':'Kordestan',
'krm':'Kerman',
'kr-sh':'Kerman Shah',
'khb':'Kohkilooye Boyer Ahmad',
'gls':'Golestan',
'gil':'Gilan',
'lor':'Lorestan',
'maz':'Mazandaran',
'mrk':'Markazi',
'hrm':'Hormozgan',
'hmd':'Hamedan',
'yzd':'Yazd',
};



const addressList = document.getElementById('address-list');
const selectedAddressFields = document.getElementById('selected-address-fields');

data.addresses.forEach(address => {//////////////////////////////////////////
  const radioContainer = document.createElement('div');
  radioContainer.className = 'radio-container';

  const radioInput = document.createElement('input');
  radioInput.type = 'radio';
  radioInput.name = 'selected_address';
  radioInput.value = address.id;
  radioContainer.appendChild(radioInput);

  const radioLabel = document.createElement('label');
  radioLabel.textContent = address.address+' '+address.city;
  radioContainer.appendChild(radioLabel);

  radioInput.addEventListener('change', () => {
    // Show the address fields when a checkbox is clicked
    selectedAddressFields.style.display = 'block';
    // Update the address fields with the corresponding values
    document.getElementById('c_address').value = address.address;
    document.getElementById('c_city').value = address.city;
    document.getElementById('c_address_id').value = address.id;
    document.getElementById('c_state_country').value = provinceValueMap[address.province];
    document.getElementById('c_postal_zip').value = address.postal_code;

    
    
  });
  
  addressList.appendChild(radioContainer);
});}






</script>
{% endblock %}